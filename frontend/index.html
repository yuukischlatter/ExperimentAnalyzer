<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Experiment Analyzer - Schlatter</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- CSS Stylesheets -->
    <link rel="stylesheet" href="/shared/styles/variables.css">
    <link rel="stylesheet" href="/shared/styles/common.css">

    <!-- Preload critical resources -->
    <link rel="preload" href="/shared/styles/variables.css" as="style">
    <link rel="preload" href="/shared/styles/common.css" as="style">

    <!-- Add this line in the <head> section -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>

</head>
<body>
    <!-- Main Application Container -->
    <div id="app" class="app-container">

        <!-- Application Header -->
        <header class="app-header">
            <div class="container">
                <div class="flex items-center justify-between">
                    <div class="app-title">
                        <h1>Experiment Analyzer</h1>
                        <p class="text-primary text-sm">Welding Data Analysis System</p>
                    </div>

                    <div class="app-logo">
                        <img src="/logo.png" alt="Schlatter" class="schlatter-logo-img">
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="app-main">
            <div class="container">

                <!-- Module Container: Experiment Browser -->
                <section id="experiment-browser-container" class="module-container">
                    <!-- Experiment browser module will be loaded here -->
                </section>

                <!-- Module Container: Data Visualization Modules -->
                <section id="data-modules-container" class="module-container hidden">
                    <div class="data-modules-grid">

                        <!-- Binary Oscilloscope Module -->
                        <div id="bin-oscilloscope-container" class="data-module-slot foldable-module hidden">
                            <!-- bin-oscilloscope module loads here -->
                        </div>

                        <!-- Ambient Temperature Module -->
                        <div id="ambient-temperature-container" class="data-module-slot foldable-module hidden">
                            <!-- ambient-temperature module loads here -->
                        </div>

                        <!-- Acceleration Data Module -->
                        <div id="acceleration-container" class="data-module-slot foldable-module hidden">
                            <!-- acceleration module loads here -->
                        </div>

                        <!-- Position Sensor Module -->
                        <div id="position-container" class="data-module-slot foldable-module hidden">
                            <!-- position module loads here -->
                        </div>

                        <!-- Tensile Strength Module -->
                        <div id="tensile-strength-container" class="data-module-slot foldable-module hidden">
                            <!-- tensile-strength module loads here -->
                        </div>

                        <!-- Photo Gallery Module -->
                        <div id="photo-gallery-container" class="data-module-slot foldable-module hidden">
                            <!-- photo-gallery module loads here -->
                        </div>

                        <!-- Thermal IR Module -->
                        <div id="thermal-ir-container" class="data-module-slot foldable-module hidden">
                            <!-- thermal-ir module loads here -->
                        </div>

                        <!-- TCP5 Oscilloscope Module -->
                        <div id="tcp5-oscilloscope-container" class="data-module-slot foldable-module hidden">
                            <!-- tcp5-oscilloscope module loads here -->
                        </div>

                        <!-- Weld Journal Module -->
                        <div id="weld-journal-container" class="data-module-slot foldable-module hidden">
                            <!-- weld-journal module loads here -->
                        </div>

                        <!-- Crown Measurements Module -->
                        <div id="crown-measurements-container" class="data-module-slot foldable-module hidden">
                            <!-- crown-measurements module loads here -->
                        </div>

                    </div>
                </section>

                <!-- Module Container: Analysis Modules -->
                <section id="analysis-modules-container" class="module-container hidden">
                    <div class="analysis-modules-grid">

                        <!-- Multi-Axis Plotter Module -->
                        <div id="multi-axis-plotter-container" class="analysis-module-slot hidden">
                            <!-- multi-axis-plotter module loads here -->
                        </div>

                        <!-- FFT Analyzer Module -->
                        <div id="fft-analyzer-container" class="analysis-module-slot hidden">
                            <!-- fft-analyzer module loads here -->
                        </div>

                        <!-- Comparison Viewer Module -->
                        <div id="comparison-viewer-container" class="analysis-module-slot hidden">
                            <!-- comparison-viewer module loads here -->
                        </div>

                    </div>
                </section>

            </div>
        </main>

        <!-- Application Footer -->
        <footer class="app-footer">
            <div class="container">
                <div class="flex items-center justify-between">
                    <div class="footer-info">
                        <p class="text-sm text-muted">
                            Â© 2025 Schlatter Industries AG - Experiment Analyzer v1.0
                        </p>
                    </div>
                    <div class="footer-status">
                        <span id="connection-status" class="text-sm text-muted">
                            Connected to API
                        </span>
                    </div>
                </div>
            </div>
        </footer>

    </div>

    <!-- Loading Overlay -->
    <div id="app-loading" class="app-loading hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Loading Experiment Analyzer...</p>
        </div>
    </div>

    <!-- Error Overlay -->
    <div id="app-error" class="app-error hidden">
        <div class="error-content">
            <h3>Application Error</h3>
            <p id="error-message">An error occurred while loading the application.</p>
            <button id="retry-button" class="btn btn-primary">Retry</button>
        </div>
    </div>

    <!-- JavaScript Application -->
    <script src="/app.js"></script>

    <!-- Module Scripts (loaded dynamically by app.js) -->
    <!-- experiment-browser module will be loaded first -->
    <!-- Other modules loaded on demand when experiments are selected -->

</body>
</html>

<style>
/* Application-specific styles (not in common.css) */
.app-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.app-header {
    background-color: var(--bg-white);
    color: var(--text-primary);
    padding: var(--spacing-md) 0;
    box-shadow: var(--shadow-md);
}

.app-title h1 {
    color: var(--schlatter-blue);
    font-size: var(--font-xxxl);
    font-weight: var(--font-semibold);
    margin: 0;
}

.schlatter-logo-img {
    height: 100px;
    width: auto;
    max-width: 400px;
}

.app-main {
    flex: 1;
    padding: var(--spacing-lg) 0;
    background-color: var(--bg-light);
}

.module-container {
    margin-bottom: var(--spacing-xl);
}

/* UPDATED: Changed to single column layout for vertical stacking */
.data-modules-grid {
    display: grid;
    grid-template-columns: 1fr; /* Single column instead of auto-fit minmax */
    gap: var(--spacing-lg);
    margin-top: var(--spacing-lg);
}

.analysis-modules-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-lg);
    margin-top: var(--spacing-lg);
}

.data-module-slot,
.analysis-module-slot {
    background-color: var(--bg-white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    width: 100%; /* Ensure full width */
}

.app-footer {
    background-color: var(--bg-section);
    border-top: 1px solid var(--border-light);
    padding: var(--spacing-md) 0;
}

/* Loading and Error Overlays */
.app-loading,
.app-error {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: var(--z-modal);
}

.loading-content,
.error-content {
    text-align: center;
    padding: var(--spacing-xl);
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--border-light);
    border-top: 4px solid var(--schlatter-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto var(--spacing-md);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-content h3 {
    color: var(--status-error);
    margin-bottom: var(--spacing-md);
}

/* Responsive adjustments for larger screens */
@media (min-width: 1400px) {
    .data-modules-grid {
        gap: var(--spacing-xl); /* Larger gaps on bigger screens */
    }
}

/* === FOLDABLE MODULE FUNCTIONALITY === */

/* Foldable module styles */
.foldable-module {
    transition: all var(--transition-normal);
}

.foldable-module .card-header {
    cursor: pointer;
    user-select: none;
    transition: background-color var(--transition-fast);
    position: relative;
}

.foldable-module .card-header:hover {
    background-color: rgba(var(--schlatter-blue-rgb), 0.95);
}

/* Fold arrow styles */
.fold-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.2);
    transition: all var(--transition-fast);
    color: var(--text-white);
    cursor: pointer;
    flex-shrink: 0;
}

.fold-arrow:hover {
    background-color: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.fold-arrow svg {
    transition: transform var(--transition-normal);
    width: 16px;
    height: 16px;
}

/* Collapsed state */
.foldable-module.collapsed .fold-arrow svg {
    transform: rotate(-90deg);
}

.foldable-module.collapsed .module-content {
    max-height: 0;
    overflow: hidden;
    padding-top: 0;
    padding-bottom: 0;
}

/* Module content transitions */
.module-content {
    max-height: 1000px; /* Large enough for content */
    overflow: hidden;
    transition: all var(--transition-slow);
}

/* Collapsed indicator */
.foldable-module.collapsed .card-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.3) 0%, 
        rgba(255, 255, 255, 0.6) 50%, 
        rgba(255, 255, 255, 0.3) 100%);
}

/* Print optimization */
@media print {
    .data-modules-grid {
        display: block; /* Stack everything for print */
    }
    
    .data-module-slot {
        page-break-inside: avoid;
        margin-bottom: var(--spacing-lg);
    }
    
    /* Expand all modules for print */
    .foldable-module.collapsed .module-content {
        max-height: none !important;
        overflow: visible !important;
        padding: var(--spacing-md) !important;
    }
    
    .fold-arrow {
        display: none !important;
    }
}
</style>

<script>
// Global Foldable Module Functionality - FIXED TIMING VERSION
document.addEventListener('DOMContentLoaded', function() {
    
    // Initialize foldable functionality for a specific module
    function initializeFoldableModule(moduleContainer) {
        // Skip if already initialized
        if (moduleContainer.hasAttribute('data-foldable-initialized')) {
            return;
        }
        
        // Find the header - look for elements with class containing 'header'
        const header = moduleContainer.querySelector('[class*="-header"]');
        
        // Find the content - look for elements with class containing 'content']
        const content = moduleContainer.querySelector('[class*="-content"]');
        
        if (header && content) {
            // Find the title container - look for elements with class containing 'title'
            const titleContainer = header.querySelector('[class*="-title"]');
            
            if (titleContainer) {
                // Add fold arrow to title container if it doesn't exist
                if (!header.querySelector('.fold-arrow')) {
                    // Create arrow element
                    const arrowDiv = document.createElement('div');
                    arrowDiv.className = 'fold-arrow';
                    arrowDiv.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    `;
                    
                    // Find the outer flex container in header and add arrow to it
                    const flexContainer = header.querySelector('.flex.items-center.justify-between');
                    if (flexContainer) {
                        flexContainer.appendChild(arrowDiv);
                    } else {
                        // Fallback: add to header directly
                        header.appendChild(arrowDiv);
                    }
                }
            }
            
            // Add module-content class for consistent styling
            content.classList.add('module-content');
            
            // Add click handler to header
            header.addEventListener('click', function(event) {
                // Prevent other click handlers from interfering
                event.stopPropagation();
                
                moduleContainer.classList.toggle('collapsed');
                
                // Store collapse state in localStorage
                const moduleId = moduleContainer.id;
                const isCollapsed = moduleContainer.classList.contains('collapsed');
                localStorage.setItem(`module-${moduleId}-collapsed`, isCollapsed);
            });
            
            // Restore collapse state from localStorage
            const moduleId = moduleContainer.id;
            const wasCollapsed = localStorage.getItem(`module-${moduleId}-collapsed`) === 'true';
            if (wasCollapsed) {
                moduleContainer.classList.add('collapsed');
            }
            
            // Mark as initialized
            moduleContainer.setAttribute('data-foldable-initialized', 'true');
            
            console.log(`Folding initialized for module: ${moduleId}`);
        } else {
            console.warn(`Could not initialize folding for module: header or content not found`, {
                moduleId: moduleContainer.id,
                hasHeader: !!header,
                hasContent: !!content
            });
        }
    }
    
    // Listen for module-ready-for-folding events from app.js
    document.addEventListener('module:ready-for-folding', function(event) {
        const { containerId, moduleName } = event.detail;
        
        console.log(`Received folding event for module: ${moduleName}, container: ${containerId}`);
        
        // Find the container and initialize folding
        const moduleContainer = document.getElementById(containerId);
        if (moduleContainer) {
            // Small delay to ensure DOM is fully updated
            setTimeout(() => {
                initializeFoldableModule(moduleContainer);
            }, 100);
        } else {
            console.warn(`Module container not found: ${containerId}`);
        }
    });
    
    // Also initialize any existing foldable modules (for modules that load immediately)
    // But only check containers that actually have content
    function initializeExistingModules() {
        const foldableModules = document.querySelectorAll('.foldable-module');
        
        foldableModules.forEach(moduleContainer => {
            // Only initialize if it has content (not just empty container)
            const hasContent = moduleContainer.querySelector('[class*="-header"]');
            if (hasContent) {
                initializeFoldableModule(moduleContainer);
            }
        });
    }
    
    // Initialize any modules that are already loaded
    initializeExistingModules();
    
    // Watch for new modules being added to the DOM (backup mechanism)
    const observer = new MutationObserver(function(mutations) {
        let needsCheck = false;
        
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        // Check if content was added to a foldable module
                        if (node.querySelector && node.querySelector('[class*="-header"]')) {
                            needsCheck = true;
                        }
                    }
                });
            }
        });
        
        // Check for new modules if content was added
        if (needsCheck) {
            setTimeout(initializeExistingModules, 150);
        }
    });
    
    // Observe the entire data modules container for changes
    const dataModulesContainer = document.getElementById('data-modules-container');
    if (dataModulesContainer) {
        observer.observe(dataModulesContainer, {
            childList: true,
            subtree: true
        });
    }
    
    // Also observe experiment browser container
    const expBrowserContainer = document.getElementById('experiment-browser-container');
    if (expBrowserContainer) {
        observer.observe(expBrowserContainer, {
            childList: true,
            subtree: true
        });
    }
    
    // Global functions to expand/collapse all modules
    window.expandAllModules = function() {
        document.querySelectorAll('.foldable-module.collapsed').forEach(module => {
            module.classList.remove('collapsed');
            localStorage.setItem(`module-${module.id}-collapsed`, false);
        });
    };
    
    window.collapseAllModules = function() {
        document.querySelectorAll('.foldable-module:not(.collapsed)').forEach(module => {
            module.classList.add('collapsed');
            localStorage.setItem(`module-${module.id}-collapsed`, true);
        });
    };
});
</script>